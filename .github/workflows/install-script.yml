name: Install Script

on:
  push:
    branches: [main, dev/**, feature/**]
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/install-script.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/install-script.yml'

jobs:
  test-install-script:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install script syntax
        run: bash -n scripts/install.sh

      - name: Test install script help
        run: bash scripts/install.sh --help

      - name: Run install script (local source)
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify tuft command exists
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          which tuft
          tuft --help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify tuft version
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft version
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify Python environment
        run: |
          test -f "${TUFT_HOME}/venv/bin/python"
          "${TUFT_HOME}/venv/bin/python" -c "import tuft; print('tuft imported successfully')"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test tuft launch (dry run - check config error)
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          # Should fail with config error, not import error
          tuft launch 2>&1 | grep -q "model-config" || tuft launch 2>&1 | grep -q "model_config"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-install-with-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run install script with backend (local source)
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE" --with-backend
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify backend dependencies installed
        run: |
          "${TUFT_HOME}/venv/bin/python" -c "import peft; print('peft imported successfully')"
          "${TUFT_HOME}/venv/bin/python" -c "import redis; print('redis imported successfully')"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-wrapper-commands:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install tuft
        run: bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test help command
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test version command
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft version
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test upgrade command
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft upgrade
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft
